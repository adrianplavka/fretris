!function(t){var s={};function i(e){if(s[e])return s[e].exports;var h=s[e]={i:e,l:!1,exports:{}};return t[e].call(h.exports,h,h.exports,i),h.l=!0,h.exports}i.m=t,i.c=s,i.d=function(t,s,e){i.o(t,s)||Object.defineProperty(t,s,{enumerable:!0,get:e})},i.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},i.t=function(t,s){if(1&s&&(t=i(t)),8&s)return t;if(4&s&&"object"==typeof t&&t&&t.__esModule)return t;var e=Object.create(null);if(i.r(e),Object.defineProperty(e,"default",{enumerable:!0,value:t}),2&s&&"string"!=typeof t)for(var h in t)i.d(e,h,function(s){return t[s]}.bind(null,h));return e},i.n=function(t){var s=t&&t.__esModule?function(){return t.default}:function(){return t};return i.d(s,"a",s),s},i.o=function(t,s){return Object.prototype.hasOwnProperty.call(t,s)},i.p="",i(i.s=2)}([function(t,s,i){"use strict";Object.defineProperty(s,"__esModule",{value:!0});const e=i(3),h=i(4),o=i(1),n=i(5);s.app=e(),s.server=h.createServer(s.app),s.io=o(s.server),s.app.use(e.static("src/client/web/.dist/")),s.app.get("*",(t,s)=>{s.status(200).sendFile(`${process.cwd()}/src/client/web/.dist/`)}),s.players=new Map;const r=new Map;s.io.on("connection",t=>{t.emit("connection"),t.on("join",i=>{s.players.set(t.id,i),t.broadcast.emit("join",i)}),t.on("chat message",i=>{s.io.emit("chat message",{sender:s.players.get(t.id),msg:i})}),t.on("check room",s=>{let i=!0;const e=r.get(s);(!e||e.player1&&e.player2)&&(i=!1),t.emit("check room",i)}),t.on("create room",()=>{const i=Math.random().toString(36).substr(2,5),e=s.io.of(i);r.set(i,new n.GameNamespace(i,e)),t.emit("create room",i)})})},function(t,s){t.exports=require("socket.io")},function(t,s,i){"use strict";Object.defineProperty(s,"__esModule",{value:!0});i(0).server.listen(process.env.PORT||8e3),console.log("<Tetris Online> @ Index > Started on port",8e3)},function(t,s){t.exports=require("express")},function(t,s){t.exports=require("http")},function(t,s,i){"use strict";Object.defineProperty(s,"__esModule",{value:!0}),i(1);const e=i(0);class h{constructor(t,s){this.x=t,this.y=s}}s.Point=h;class o{constructor(t){this.rotation=0,this.s=t}move(t,s){for(var i=[],e=0;e<this.points.length;e++)i.push(new h(this.points[e].x+t,this.points[e].y+s));return i}setPos(t){this.points=t}drop(){return this.move(0,1)}moveLeft(){return this.move(-1,0)}moveRight(){return this.move(1,0)}rotate(t){throw new Error("This method is abstract")}}s.Shape=o;class n extends o{constructor(t,s){super(s),this.fillColor="#1dcd9f";var i=t/2;this.points=[],this.points.push(new h(i,-2)),this.points.push(new h(i+1,-2)),this.points.push(new h(i,-1)),this.points.push(new h(i+1,-1))}rotate(t){return this.points}}s.SquareShape=n;class r extends o{constructor(t,s,i){super(i),this.leftHanded=t,this.fillColor=t?"#ff395e":"#0fc9e7";var e=s/2;this.points=[],this.points.push(new h(e,-3)),this.points.push(new h(e,-2)),this.points.push(new h(e,-1)),this.points.push(new h(e+(t?-1:1),-1))}rotate(t){this.rotation=(this.rotation+(t?1:-1))%4;var s=[];switch(this.rotation){case 0:s.push(new h(this.points[1].x,this.points[1].y-1)),s.push(new h(this.points[1].x,this.points[1].y)),s.push(new h(this.points[1].x,this.points[1].y+1)),s.push(new h(this.points[1].x+(this.leftHanded?-1:1),this.points[1].y+1));break;case 1:s.push(new h(this.points[1].x+1,this.points[1].y)),s.push(new h(this.points[1].x,this.points[1].y)),s.push(new h(this.points[1].x-1,this.points[1].y)),s.push(new h(this.points[1].x-1,this.points[1].y+(this.leftHanded?-1:1)));break;case 2:s.push(new h(this.points[1].x,this.points[1].y+1)),s.push(new h(this.points[1].x,this.points[1].y)),s.push(new h(this.points[1].x,this.points[1].y-1)),s.push(new h(this.points[1].x+(this.leftHanded?1:-1),this.points[1].y-1));break;case 3:s.push(new h(this.points[1].x-1,this.points[1].y)),s.push(new h(this.points[1].x,this.points[1].y)),s.push(new h(this.points[1].x+1,this.points[1].y)),s.push(new h(this.points[1].x+1,this.points[1].y+(this.leftHanded?1:-1)))}return s}}s.LShape=r;class a extends o{constructor(t,s,i){super(i),this.fillColor=t?"#3e4377":"#e9007f",this.leftHanded=t;var e=s/2;this.points=[],this.points.push(new h(e+(t?1:-1),-1)),this.points.push(new h(e,-1)),this.points.push(new h(e,-2)),this.points.push(new h(e+(t?-1:1),-2))}rotate(t){this.rotation=(this.rotation+(t?1:-1))%2;var s=[];switch(this.rotation){case 0:s.push(new h(this.points[1].x+(this.leftHanded?1:-1),this.points[1].y)),s.push(new h(this.points[1].x,this.points[1].y)),s.push(new h(this.points[1].x,this.points[1].y-1)),s.push(new h(this.points[1].x+(this.leftHanded?-1:1),this.points[1].y-1));break;case 1:s.push(new h(this.points[1].x,this.points[1].y+(this.leftHanded?1:-1))),s.push(new h(this.points[1].x,this.points[1].y)),s.push(new h(this.points[1].x+1,this.points[1].y)),s.push(new h(this.points[1].x+1,this.points[1].y+(this.leftHanded?-1:1)))}return s}}s.StepShape=a;class p extends o{constructor(t,s){super(s),this.fillColor="#4a2c2c";var i=t/2;this.points=[],this.points.push(new h(i,-4)),this.points.push(new h(i,-3)),this.points.push(new h(i,-2)),this.points.push(new h(i,-1))}rotate(t){this.rotation=(this.rotation+(t?1:-1))%2;var s=[];switch(this.rotation){case 0:s[0]=new h(this.points[2].x,this.points[2].y-2),s[1]=new h(this.points[2].x,this.points[2].y-1),s[2]=new h(this.points[2].x,this.points[2].y),s[3]=new h(this.points[2].x,this.points[2].y+1);break;case 1:s[0]=new h(this.points[2].x+2,this.points[2].y),s[1]=new h(this.points[2].x+1,this.points[2].y),s[2]=new h(this.points[2].x,this.points[2].y),s[3]=new h(this.points[2].x-1,this.points[2].y)}return s}}s.StraightShape=p;class c extends o{constructor(t,s){super(s),this.fillColor="#ffd05b",this.points=[];var i=t/2;this.points.push(new h(i-1,-2)),this.points.push(new h(i,-2)),this.points.push(new h(i+1,-2)),this.points.push(new h(i,-1))}rotate(t){this.rotation=(this.rotation+(t?1:-1))%4;var s=[];switch(this.rotation){case 0:s.push(new h(this.points[1].x-1,this.points[1].y)),s.push(new h(this.points[1].x,this.points[1].y)),s.push(new h(this.points[1].x+1,this.points[1].y)),s.push(new h(this.points[1].x,this.points[1].y+1));break;case 1:s.push(new h(this.points[1].x,this.points[1].y-1)),s.push(new h(this.points[1].x,this.points[1].y)),s.push(new h(this.points[1].x,this.points[1].y+1)),s.push(new h(this.points[1].x-1,this.points[1].y));break;case 2:s.push(new h(this.points[1].x+1,this.points[1].y)),s.push(new h(this.points[1].x,this.points[1].y)),s.push(new h(this.points[1].x-1,this.points[1].y)),s.push(new h(this.points[1].x,this.points[1].y-1));break;case 3:s.push(new h(this.points[1].x,this.points[1].y+1)),s.push(new h(this.points[1].x,this.points[1].y)),s.push(new h(this.points[1].x,this.points[1].y-1)),s.push(new h(this.points[1].x+1,this.points[1].y))}return s}}s.TShape=c;class l{constructor(t,s,i){this.blockSize=i,this.blockColor=new Array(t),this.cols=s,this.rows=t;for(var e=0;e<t;e++)this.blockColor[e]=new Array(s);this.xOffset=20,this.yOffset=20}draw(t){this.paintShape(t,t.fillColor)}erase(t){this.paintShape(t,this.backColor)}paintShape(t,s){t.points.forEach(t=>this.paintSquare(t.y,t.x,s))}getPreferredSize(){return new h(this.blockSize*this.cols,this.blockSize*this.rows)}isPosValid(t){for(var s=!0,i=0;i<t.length;i++){if(t[i].x<0||t[i].x>=this.cols||t[i].y>=this.rows){s=!1;break}if(t[i].y>=0&&this.blockColor[t[i].y][t[i].x]!=this.backColor){s=!1;break}}return s}addShape(t){for(var s=0;s<t.points.length;s++){if(t.points[s].y<0)return!1;this.blockColor[t.points[s].y][t.points[s].x]=t.fillColor}return!0}eraseGrid(){this.cols,this.blockSize,this.rows,this.blockSize}clearGrid(){for(var t=0;t<this.rows;t++)for(var s=0;s<this.cols;s++)this.blockColor[t][s]=this.backColor;this.eraseGrid()}paintSquare(t,s,i){}drawGrid(){for(var t=0;t<this.rows;t++)for(var s=0;s<this.cols;s++)this.blockColor[t][s]!==this.backColor&&this.paintSquare(t,s,this.blockColor[t][s])}paint(){this.eraseGrid(),this.drawGrid()}checkRows(t){for(var s,i=t.points[0].y,e=t.points[0].y,h=0,o=1;o<t.points.length;o++)t.points[o].y<i&&(i=t.points[o].y),t.points[o].y>e&&(e=t.points[o].y);for(i<0&&(i=0);e>=i;){s=!0;for(var n=0;n<this.cols;n++)if(this.blockColor[e][n]==this.backColor){s=!1;break}if(s){h++;for(var r=e;r>=0;r--)for(n=0;n<this.cols;n++)this.blockColor[r][n]=r>0?this.blockColor[r-1][n]:this.backColor;i++}else e--}return h>0&&(this.eraseGrid(),this.paint()),h}}s.Grid=l;s.GameNamespace=class{constructor(t,s){this.id=t,this.io=s,this.game1=new u(s),this.game2=new u(s),this.games=new Map,this.io.on("connection",t=>{this.player1?this.player2?t.disconnect():(this.player2={id:t.id,name:e.players.get(t.id)},this.games[t.id]=this.game2,this.game2.id=t.id,this.game1.startGame(),this.game2.startGame()):(this.player1={id:t.id,name:e.players.get(t.id)},this.games[t.id]=this.game1,this.game1.id=t.id),t.on("move",i=>{if(this.games[t.id].phase==u.gameState.playing){var e=[];switch(i){case"right":e=this.games[t.id].currentShape.moveRight(),this.games[t.id].grid.isPosValid(e)&&(this.games[t.id].currentShape.setPos(e),s.emit("move",i,t.id));break;case"left":e=this.games[t.id].currentShape.moveLeft(),this.games[t.id].grid.isPosValid(e)&&(this.games[t.id].currentShape.setPos(e),s.emit("move",i,t.id));break;case"up":e=this.games[t.id].currentShape.rotate(!0),this.games[t.id].grid.isPosValid(e)&&(this.games[t.id].currentShape.setPos(e),s.emit("move",i,t.id));break;case"down":e=this.games[t.id].currentShape.drop(),this.games[t.id].grid.isPosValid(e)&&(this.games[t.id].currentShape.setPos(e),s.emit("move",i,t.id))}}}),t.on("start game",()=>{this.game1.startGame(),this.game2.startGame()}),t.on("toggle pause",()=>{this.game1.togglePause(),this.game2.togglePause()}),t.on("increment level",()=>{this.game1.incrementLevel(),this.game2.incrementLevel()})})}};class u{constructor(t){this.phase=u.gameState.initial,this.randomShapes=[],this.running=!1,this.io=t,this.speed=1e3,this.grid=new l(16,10,20)}startGame(){this.grid.clearGrid(),this.currentShape=this.newShape(),this.nextShape=this.newShape(),this.score=0,this.rowsCompleted=0,this.level=-1,this.speed=900,this.phase=u.gameState.playing,this.randomShapes=[],this.incrementLevel(),this.io.emit("start game",{currentShape:this.currentShape.s,nextShape:this.nextShape.s},this.id),clearTimeout(this.timerToken),this.timerToken=setInterval(()=>{this.gameTimer()},this.speed)}gameTimer(){if(this.phase==u.gameState.playing){var t=this.currentShape.drop();this.grid.isPosValid(t)?(this.currentShape.setPos(t),this.io.emit("tick",this.id)):this.shapeFinished()}}shapeFinished(){if(this.grid.addShape(this.currentShape)){this.grid.draw(this.currentShape);const t=this.grid.checkRows(this.currentShape);this.rowsCompleted+=t,this.score+=t*(this.level+1)*10,this.rowsCompleted>10*(this.level+1)&&this.incrementLevel(),this.currentShape=this.nextShape,this.nextShape=this.newShape(),this.io.emit("shape finished",this.nextShape.s,this.id),this.io.emit("score",this.score,this.id)}else this.phase=u.gameState.gameover,clearTimeout(this.timerToken)}incrementLevel(){var t;this.level<7&&(this.level++,this.speed-=100,clearTimeout(this.timerToken),this.timerToken=setInterval((t=this,function(){t.gameTimer()}),this.speed))}togglePause(){this.phase==u.gameState.paused?(this.phase=u.gameState.playing,this.io.emit("unpause",this.id)):this.phase==u.gameState.playing&&(this.phase=u.gameState.paused,this.io.emit("pause",this.id))}newShape(){0===this.randomShapes.length&&(this.randomShapes=["L","L","L","L","LR","LR","LR","LR","T","T","T","T","SS","SS","SS","SS","SZ","SZ","SZ","SZ","S","S","S","S","I","I","I","I"]);var t=Math.floor(Math.random()*this.randomShapes.length-1),s=this.randomShapes.splice(t,1)[0];switch(s){case"L":s=new r(!1,this.grid.cols,"L");break;case"LR":s=new r(!0,this.grid.cols,"LR");break;case"T":(s=new c(this.grid.cols,"T")).setPos(s.rotate(!0));break;case"SS":s=new a(!1,this.grid.cols,"SS");break;case"SZ":s=new a(!0,this.grid.cols,"SZ");break;case"S":s=new n(this.grid.cols,"S");break;case"I":(s=new p(this.grid.cols,"I")).setPos(s.rotate(!0));break;default:s=new r(!1,this.grid.cols,"L")}return s}}u.gameState={initial:0,playing:1,paused:2,gameover:3},s.Game=u}]);